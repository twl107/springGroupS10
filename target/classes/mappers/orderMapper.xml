<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.springGroupS10.dao.OrderDAO">

	<select id="getOrderByOrderId" resultType="com.spring.springGroupS10.vo.OrderVO">
		SELECT * FROM orders WHERE orderId = #{orderId}
	</select>
	
	<select id="getOrderByOrderIdAndMember" resultType="com.spring.springGroupS10.vo.OrderVO">
		SELECT * FROM orders WHERE orderId = #{orderId} AND memberIdx = #{memberIdx}
	</select>
	
	<select id="getOrderDetailItems" resultType="com.spring.springGroupS10.vo.OrderDetailVO">
		SELECT
			d.*,
			p.productName AS productName,
			p.fSName AS fSName,
			o.optionName AS optionName
		FROM orderDetails d
		JOIN dbProduct p ON d.productIdx = p.idx
		LEFT JOIN dbOption o ON d.optionIdx = o.idx
		WHERE d.orderIdx = #{orderIdx}
	</select>

	<select id="getAdminOrderTotalCnt" resultType="int">
		select count(*) from orders
		<if test="status != '전체'">
			where orderStatus = #{status}
		</if>
	</select>
	
	<select id="getAdminOrderList" resultType="com.spring.springGroupS10.vo.OrderVO">
		<if test="orderStatus == '전체'">
			select * from orders <![CDATA[ where date(orderDate) >= date(#{startJumun}) and date(orderDate) <= date(#{endJumun}) order by orderDate desc ]]> limit #{startIndexNo},#{pageSize};
		</if>
		<if test="orderStatus != '전체'">
			select * from orders <![CDATA[ where date(orderDate) >= date(#{startJumun}) and date(orderDate) <= date(#{endJumun}) and orderStatus=#{orderStatus} order by orderDate desc ]]> limit #{startIndexNo},#{pageSize};
		</if>
	</select>

	<select id="getRecentOrderList" resultType="com.spring.springGroupS10.vo.OrderVO">
		SELECT 
	    o.orderId, o.orderDate, o.totalPrice, o.orderStatus,
	    (SELECT p.productName FROM orderDetails od JOIN dbProduct p ON od.productIdx = p.idx WHERE od.orderIdx = o.idx LIMIT 1) AS mainProductName,
	    (SELECT COUNT(*) FROM orderDetails od WHERE od.orderIdx = o.idx) AS itemCount
		FROM orders o
		WHERE o.memberIdx = #{memberIdx}
		ORDER BY o.orderDate DESC
		LIMIT #{i};
	</select>

	<select id="getTotRecCntAdminOrder" resultType="int">
		<if test="orderStatus == '전체'">
			select count(*) from orders <![CDATA[ where date(orderDate) >= date(#{startJumun}) and date(orderDate) <= date(#{endJumun}) ]]>
		</if>
		<if test="orderStatus != '전체'">
        select count(*) from orders <![CDATA[ where date(orderDate) >= date(#{startJumun}) and date(orderDate) <= date(#{endJumun}) and orderStatus=#{orderStatus} ]]>
    </if>
	</select>

	<select id="getMyOrderList" resultType="com.spring.springGroupS10.vo.OrderVO">
	  SELECT
	    o.*,
	    (SELECT
	       CASE
	         WHEN COUNT(od.idx) = 1 THEN ANY_VALUE(p.productName)
	         ELSE CONCAT(ANY_VALUE(p.productName), ' 외 ', COUNT(od.idx) - 1, '건')
	       END
	     FROM orderDetails od
	     JOIN dbProduct p ON od.productIdx = p.idx
	     WHERE od.orderIdx = o.idx
	     GROUP BY od.orderIdx
	     -- ORDER BY od.idx ASC LIMIT 1 은 GROUP BY 안에서는 큰 의미가 없으므로 제거해도 무방합니다.
	     -- LIMIT 1
	    ) AS mainProductName
	  FROM orders o
	  WHERE o.memberIdx = #{memberIdx}
	    <![CDATA[ and date(o.orderDate) >= date(#{startJumun}) and date(o.orderDate) <= date(#{endJumun})]]>
	    <if test="orderStatus != '전체'">
	      and o.orderStatus = #{orderStatus}
	    </if>
	  ORDER BY o.orderDate DESC
	  LIMIT #{startIndexNo}, #{pageSize};
	</select>

	<select id="getMyOrdersTotRecCnt" resultType="int">
	  select count(*) from orders
	  where memberIdx = #{memberIdx}
	  <![CDATA[ 
	    and date(orderDate) >= date(#{startJumun}) 
	    and date(orderDate) <= date(#{endJumun}) 
	  ]]>
	  <if test="orderStatus != '전체'">
	    and orderStatus = #{orderStatus}
	  </if>
	</select>
	
	<select id="getSalesByDate" resultType="long">
	  SELECT IFNULL(SUM(totalPrice), 0) 
	  FROM orders
	  WHERE orderStatus IN ('결제완료', '배송준비중', '배송중', '배송완료')
	  <if test="period == 'today'">
	    AND DATE(orderDate) = CURDATE()
	  </if>
	  <if test="period == 'month'">
	    AND YEAR(orderDate) = YEAR(CURDATE()) 
	    AND MONTH(orderDate) = MONTH(CURDATE())
	  </if>
	</select>

	<select id="getOrderCountByStatus" resultType="int">
	  SELECT count(*) FROM orders WHERE orderStatus = #{orderStatus};
	</select>


	<insert id="insertOrder" useGeneratedKeys="true" keyProperty="orderVO.idx">
		INSERT INTO orders (
			orderId, memberIdx, totalPrice,
			recipientName, recipientTel, recipientPostCode, recipientAddress1, recipientAddress2, shippingMessage,
			orderStatus, imp_uid
		) VALUES (
			#{orderVO.orderId}, #{orderVO.memberIdx}, #{orderVO.totalPrice},
			#{orderVO.recipientName}, #{orderVO.recipientTel}, #{orderVO.recipientPostCode}, #{orderVO.recipientAddress1}, #{orderVO.recipientAddress2}, #{orderVO.shippingMessage},
			#{orderVO.orderStatus}, #{orderVO.imp_uid}
		)
	</insert>
	
	<insert id="insertOrderDetail">
		INSERT INTO orderDetails (orderIdx, productIdx, optionIdx, quantity, price)
		VALUES (#{detail.orderIdx}, #{detail.productIdx}, #{detail.optionIdx}, #{detail.quantity}, #{detail.price})
	</insert>
	
	
	<update id="setUpdateStatus">
		update orders set orderStatus = #{orderStatus} where orderId = #{orderId};
	</update>
	
	
	<delete id="deleteCartItems">
		DELETE FROM cart WHERE idx IN
		<foreach collection="cartIdxs" item="idx" open="(" separator="," close=")">
			#{idx}
		</foreach>
	</delete>

</mapper>

